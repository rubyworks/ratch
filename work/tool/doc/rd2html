#!/usr/bin/env ratch

require 'rdoc/markup/simple_markup'
require 'rdoc/markup/simple_markup/to_html'

# Convert readme files to html.
#
# Create html files from test files like README.
# The text files are expected to be in rdoc format.

main :rd2html do
  config = configuration['rd2html']

  dir   = config['dir'] || "doc"
  style = config['css']
  files = config['files']

  files ||= Dir.glob('[A-Z]*')
  style ||= Dir.glob('*.css').first

  s = SM::SimpleMarkup.new
  h = SM::ToHtml.new

  files.each do |file|
    unless File.exist?(file)
      puts "Warning: file does not exist -- #{file}"
    end
  end

  mkdir_p(dir) unless dryrun?

  files.each do |file|
    name = file.downcase.chomp('.txt')
    if /^readme/ =~ name
      name = "index"
    end
    path = File.join(dir, name + '.html')

    if dryrun?
      puts "[DRYRUN] Create #{path}"
    else
      next unless out_of_date?(path, file)

      title = "#{package.title} #{name.upcase}"

      input  = File.read(file)
      output = s.convert(input, h)

      File.open(path, 'w') do |f|
        f << %{<html>}
        f << %{<head>}
        f << %{  <title>#{title}<title>}
        f << %{  <link rel="stylesheet" TYPE="text/css" HREF="#{style}">} if style
        f << %{</head>}
        f << %{<body>}
        f << output
        f << %{</body>}
        f << %{</html>}
      end

      puts "Created #{path}"
    end
  end
end
